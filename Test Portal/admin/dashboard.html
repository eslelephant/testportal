<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Speakers' Corner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="../js/persistentStorage.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 600;
            overflow: hidden;
            padding: 3px;
        }

        .logo-image {
            width: 110%;
            height: 110%;
            object-fit: contain;
            border-radius: 50%;
        }

        h1 {
            color: #2d3748;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
            font-size: 16px;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            overflow: hidden;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            max-width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
            align-items: center;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .results-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .results-table th,
        .results-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2d3748;
            position: sticky;
            top: 0;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .grade-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .grade-excellent {
            background: #d4edda;
            color: #155724;
        }

        .grade-merit {
            background: #cce7ff;
            color: #004085;
        }

        .grade-pass {
            background: #fff3cd;
            color: #856404;
        }

        .grade-borderline {
            background: #f8d7da;
            color: #721c24;
        }

        .grade-below {
            background: #f5c6cb;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .no-results {
            text-align: center;
            color: #6c757d;
            padding: 40px;
            font-style: italic;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2d3748;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            font-family: 'Inter', sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
                padding: 20px;
            }

            .search-box {
                min-width: 100%;
                max-width: 100%;
                margin-bottom: 15px;
            }

            .control-buttons {
                justify-content: center;
                width: 100%;
            }

            .control-buttons .btn {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }

            .results-table {
                font-size: 14px;
            }

            .results-table th,
            .results-table td {
                padding: 10px 5px;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 1200px) {
            .controls {
                gap: 10px;
            }

            .control-buttons {
                gap: 8px;
            }

            .control-buttons .btn {
                padding: 10px 15px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <img src="../speakerslogo.png" alt="Speakers' Corner Logo" class="logo-image">
        </div>
        <h1>Admin Dashboard</h1>
        <p class="subtitle">Speakers' Corner Test Management System</p>
    </div>

    <div class="controls">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search by student name, email, or test level..." onkeyup="filterResults()">
        </div>
        <div class="control-buttons">
            <select id="testLevelFilter" onchange="filterByTestLevel()" class="btn" style="margin-right: 10px;">
                <option value="">All Test Levels</option>
                <option value="B1">B1 Tests Only</option>
                <option value="B2">B2 Tests Only</option>
                <option value="C1">C1 Tests Only</option>
            </select>
            <button class="btn btn-success" onclick="exportResults()">Export CSV</button>
            <button class="btn btn-primary" onclick="exportDatabase()">Export Database</button>
            <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">Import Database</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importDatabase(event)">
            <button class="btn btn-info" onclick="showStorageInfo()">Storage Info</button>
            <button class="btn btn-secondary" onclick="refreshData()">Refresh Data</button>
            <button class="btn btn-danger" onclick="clearAllResults()">Clear All Data</button>
            <a href="../index.html" class="btn btn-secondary">Back to Portal</a>
        </div>
    </div>

    <div class="results-container">
        <div class="stats-row" id="statsRow">
            <div class="stat-card">
                <div class="stat-number" id="totalTests">0</div>
                <div class="stat-label">Total Tests</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgScore">0%</div>
                <div class="stat-label">Average Score</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="passRate">0%</div>
                <div class="stat-label">Pass Rate (≥60%)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayTests">0</div>
                <div class="stat-label">Tests Today</div>
            </div>
        </div>

        <table class="results-table" id="resultsTable">
            <thead>
                <tr>
                    <th>Test Level</th>
                    <th>Student Name</th>
                    <th>Email</th>
                    <th>Test Date</th>
                    <th>Score</th>
                    <th>Grade</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="resultsTableBody">
                <tr>
                    <td colspan="7" class="no-results">No test results found</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Test Result</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="editForm">
                <div class="form-group">
                    <label for="editStudentName">Student Name</label>
                    <input type="text" id="editStudentName" required>
                </div>
                <div class="form-group">
                    <label for="editStudentEmail">Student Email</label>
                    <input type="email" id="editStudentEmail" required>
                </div>
                <div class="form-group">
                    <label for="editScore">Score</label>
                    <input type="number" id="editScore" min="0" max="32" required>
                </div>
                <div class="form-group">
                    <label for="editPercentage">Percentage</label>
                    <input type="number" id="editPercentage" min="0" max="100" step="0.1" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allResults = [];
        let filteredResults = [];
        let currentEditResult = null;

        // Load results when page loads
        window.addEventListener('load', async function() {
            console.log('Admin panel loading...');
            console.log('localStorage keys:', Object.keys(localStorage));
            console.log('allTestResults:', localStorage.getItem('allTestResults'));
            
            // Show all keys that start with testResult_
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('testResult_')) {
                    console.log('Found test result key:', key);
                    console.log('Data:', localStorage.getItem(key));
                }
            }
            
            await loadAllResults();
            updateStatistics();
        });

        async function loadAllResults() {
            console.log('Loading results from persistent storage...');
            
            // Use new persistent storage system
            try {
                if (window.testStorage) {
                    await window.testStorage.loadData();
                    allResults = window.testStorage.getAllResults();
                    console.log(`Loaded ${allResults.length} results from persistent storage`);
                } else {
                    console.log('Persistent storage not available, using fallback');
                    loadFromLocalStorage();
                }
            } catch (error) {
                console.error('Error loading from persistent storage:', error);
                loadFromLocalStorage();
            }
            
            // Also try to load from JSON file if available (for backward compatibility)
            try {
                const response = await fetch('../data/testResults.json');
                if (response.ok) {
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                        // Merge with localStorage data
                        const jsonResults = data.results;
                        const localResults = getAllLocalResults();
                        
                        // Combine and deduplicate
                        const combined = [...jsonResults, ...localResults];
                        const unique = combined.filter((result, index, self) =>
                            index === self.findIndex(r => r.id === result.id || 
                                (r.studentName === result.studentName && 
                                 r.testDate === result.testDate && 
                                 r.testTime === result.testTime))
                        );
                        
                        allResults = unique.sort((a, b) => 
                            new Date(b.timestamp || b.testDate + ' ' + b.testTime) - 
                            new Date(a.timestamp || a.testDate + ' ' + a.testTime)
                        );
                    }
                }
            } catch (error) {
                console.log('JSON file not available, using localStorage only');
            }
            
            filteredResults = [...allResults];
            displayResults(filteredResults);
        }

        function loadFromLocalStorage() {
            console.log('Loading from localStorage...');
            
            // First try to load from consolidated array
            const consolidatedResults = JSON.parse(localStorage.getItem('allTestResults') || '[]');
            console.log('Consolidated results found:', consolidatedResults.length);
            
            if (consolidatedResults.length > 0) {
                allResults = consolidatedResults;
                console.log('Using consolidated results');
            } else {
                // Fallback to individual keys
                console.log('No consolidated results, scanning individual keys...');
                allResults = getAllLocalResults();
                console.log('Individual results found:', allResults.length);
            }
            
            console.log('Final allResults:', allResults);
            
            filteredResults = [...allResults];
            displayResults(filteredResults);
        }
        
        function getAllLocalResults() {
            const results = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('testResult_')) {
                    try {
                        const result = JSON.parse(localStorage.getItem(key));
                        result.storageKey = key;
                        result.testLevel = result.testLevel || 'B1'; // Default to B1 if not specified
                        if (!result.id) {
                            result.id = key; // Use storage key as ID if no ID present
                        }
                        results.push(result);
                    } catch (error) {
                        console.error('Error parsing result:', error);
                    }
                }
            }
            
            // Sort by timestamp or date
            results.sort((a, b) => {
                const aTime = new Date(a.timestamp || a.testDate + ' ' + a.testTime).getTime();
                const bTime = new Date(b.timestamp || b.testDate + ' ' + b.testTime).getTime();
                return bTime - aTime; // Newest first
            });
            
            return results;
        }

        function refreshData() {
            loadAllResults();
        }

        // New persistent storage functions
        function exportDatabase() {
            try {
                if (window.testStorage) {
                    window.testStorage.exportDatabase();
                } else {
                    exportToJSON(); // Fallback to old method
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Export failed. Please try again.');
            }
        }

        function importDatabase(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (window.testStorage) {
                        const result = window.testStorage.importDatabase(importedData);
                        if (result.success) {
                            alert(`Successfully imported ${result.imported} new test results!`);
                            loadAllResults();
                        } else {
                            alert(`Import failed: ${result.error}`);
                        }
                    } else {
                        alert('Persistent storage not available');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Invalid file format. Please select a valid test results JSON file.');
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        function showStorageInfo() {
            try {
                if (window.testStorage) {
                    const info = window.testStorage.getStorageInfo();
                    const message = `
Storage Information:
• Total Results: ${info.totalResults}
• Database Size: ${info.dataSize}
• Total Storage Used: ${info.totalStorageUsed}
• Last Updated: ${new Date(info.lastUpdated).toLocaleString()}
• Backup Available: ${info.hasBackup ? 'Yes' : 'No'}
                    `;
                    alert(message);
                } else {
                    alert('Storage information not available');
                }
            } catch (error) {
                console.error('Storage info error:', error);
                alert('Error retrieving storage information');
            }
        }

        function exportToJSON() {
            // Calculate statistics
            const totalTests = allResults.length;
            const b1Results = allResults.filter(r => (r.testLevel || 'B1') === 'B1');
            const b2Results = allResults.filter(r => r.testLevel === 'B2');
            const c1Results = allResults.filter(r => r.testLevel === 'C1');

            function calculateStats(results) {
                if (results.length === 0) return { totalTests: 0, averageScore: 0, passRate: 0 };
                const totalScore = results.reduce((sum, r) => sum + r.percentage, 0);
                const averageScore = Math.round(totalScore / results.length);
                const passCount = results.filter(r => r.percentage >= 60).length;
                const passRate = Math.round((passCount / results.length) * 100);
                return { totalTests: results.length, averageScore, passRate };
            }

            const jsonData = {
                metadata: {
                    created: allResults.length > 0 ? allResults[allResults.length - 1].testDate : new Date().toISOString().split('T')[0],
                    lastUpdated: new Date().toISOString(),
                    totalTests: totalTests,
                    version: "1.0"
                },
                statistics: {
                    B1: calculateStats(b1Results),
                    B2: calculateStats(b2Results),
                    C1: calculateStats(c1Results)
                },
                results: allResults.map(result => ({
                    id: result.id || Date.now().toString(36) + Math.random().toString(36).substr(2),
                    timestamp: result.timestamp || new Date(result.testDate + ' ' + result.testTime).toISOString(),
                    testLevel: result.testLevel || 'B1',
                    studentName: result.studentName,
                    studentEmail: result.studentEmail,
                    testDate: result.testDate,
                    testTime: result.testTime,
                    totalScore: result.totalScore || result.score,
                    totalQuestions: result.totalQuestions,
                    percentage: result.percentage,
                    grade: result.grade || calculateGrade(result.percentage),
                    answers: result.answers,
                    correctAnswers: result.correctAnswers,
                    partScores: result.partScores || {}
                }))
            };

            const jsonString = JSON.stringify(jsonData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `testResults_${new Date().toISOString().split('T')[0]}.json`;
            a.style.display = 'none';
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            
            alert('JSON database file downloaded! Replace the existing testResults.json file in the data folder with this new file.');
        }

        function debugStorage() {
            console.log('=== STORAGE DEBUG ===');
            console.log('localStorage length:', localStorage.length);
            
            let testResultKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('testResult_')) {
                    testResultKeys.push(key);
                }
            }
            
            console.log('Test result keys found:', testResultKeys);
            console.log('allTestResults:', localStorage.getItem('allTestResults'));
            
            testResultKeys.forEach(key => {
                const data = localStorage.getItem(key);
                try {
                    const parsed = JSON.parse(data);
                    console.log(`${key}:`, parsed.studentName, parsed.testDate, parsed.percentage + '%');
                } catch (e) {
                    console.log(`${key}: Parse error`, data);
                }
            });
            
            console.log('allResults array length:', allResults.length);
            console.log('filteredResults array length:', filteredResults.length);
            
            alert('Debug info logged to console. Press F12 to view.');
        }

        function displayResults(results) {
            const tbody = document.getElementById('resultsTableBody');
            
            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-results">No test results found</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            
            results.forEach((result, index) => {
                const row = document.createElement('tr');
                const grade = calculateGrade(result.percentage);
                const testLevel = result.testLevel || 'B1';
                
                // Debug log each result being displayed
                console.log('Displaying result:', result.studentName, result.testDate, result.percentage);
                
                row.innerHTML = `
                    <td><span class="grade-badge grade-${testLevel.toLowerCase()}" style="background: ${getTestLevelColor(testLevel)}; color: white;">${testLevel}</span></td>
                    <td>${result.studentName || 'Unknown'}</td>
                    <td>${result.studentEmail || 'No email'}</td>
                    <td>${result.testDate || 'No date'} ${result.testTime || ''}</td>
                    <td>${result.totalScore || result.score || 0}/${result.totalQuestions || 0} (${result.percentage || 0}%)</td>
                    <td><span class="grade-badge grade-${grade.class}">${grade.grade}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="editResult('${result.id || result.storageKey || index}')">Edit</button>
                            <button class="btn btn-success btn-sm" onclick="downloadResultPDF('${result.id || result.storageKey || index}')">PDF</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteResult('${result.id || result.storageKey || index}')">Delete</button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function getTestLevelColor(level) {
            switch(level) {
                case 'B1': return '#28a745';
                case 'B2': return '#007bff';
                case 'C1': return '#6f42c1';
                default: return '#6c757d';
            }
        }

        function calculateGrade(percentage) {
            if (percentage >= 85) return { grade: 'Excellent', class: 'excellent' };
            if (percentage >= 70) return { grade: 'Pass with Merit', class: 'merit' };
            if (percentage >= 60) return { grade: 'Pass', class: 'pass' };
            if (percentage >= 45) return { grade: 'Borderline', class: 'borderline' };
            return { grade: 'Below Pass', class: 'below' };
        }

        function updateStatistics() {
            const totalTests = allResults.length;
            document.getElementById('totalTests').textContent = totalTests;

            if (totalTests === 0) {
                document.getElementById('avgScore').textContent = '0%';
                document.getElementById('passRate').textContent = '0%';
                document.getElementById('todayTests').textContent = '0';
                return;
            }

            // Calculate average score
            const avgScore = allResults.reduce((sum, result) => sum + result.percentage, 0) / totalTests;
            document.getElementById('avgScore').textContent = Math.round(avgScore) + '%';

            // Calculate pass rate (≥60%)
            const passCount = allResults.filter(result => result.percentage >= 60).length;
            const passRate = (passCount / totalTests) * 100;
            document.getElementById('passRate').textContent = Math.round(passRate) + '%';

            // Calculate today's tests
            const today = new Date().toLocaleDateString();
            const todayTests = allResults.filter(result => 
                new Date(result.testDate).toLocaleDateString() === today
            ).length;
            document.getElementById('todayTests').textContent = todayTests;
        }

        function filterResults() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const testLevel = document.getElementById('testLevelFilter').value;
            
            filteredResults = allResults.filter(result => {
                const matchesSearch = result.studentName.toLowerCase().includes(searchTerm) ||
                    result.studentEmail.toLowerCase().includes(searchTerm) ||
                    (result.testLevel || 'B1').toLowerCase().includes(searchTerm);
                
                const matchesLevel = !testLevel || (result.testLevel || 'B1') === testLevel;
                
                return matchesSearch && matchesLevel;
            });
            
            displayResults(filteredResults);
        }

        function filterByTestLevel() {
            filterResults();
        }

        function filterResults() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredResults = allResults.filter(result => 
                result.studentName.toLowerCase().includes(searchTerm) ||
                result.studentEmail.toLowerCase().includes(searchTerm)
            );
            displayResults(filteredResults);
        }

        function editResult(id) {
            const result = allResults.find(r => r.id === id || r.storageKey === id);
            if (!result) return;
            
            currentEditResult = result;
            
            document.getElementById('editStudentName').value = result.studentName;
            document.getElementById('editStudentEmail').value = result.studentEmail;
            document.getElementById('editScore').value = result.score;
            document.getElementById('editPercentage').value = result.percentage;
            
            document.getElementById('editModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditResult = null;
        }

        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentEditResult) return;
            
            currentEditResult.studentName = document.getElementById('editStudentName').value;
            currentEditResult.studentEmail = document.getElementById('editStudentEmail').value;
            currentEditResult.totalScore = parseInt(document.getElementById('editScore').value);
            currentEditResult.score = currentEditResult.totalScore; // Keep both for compatibility
            currentEditResult.percentage = parseFloat(document.getElementById('editPercentage').value);
            currentEditResult.grade = calculateGrade(currentEditResult.percentage);
            
            // Update in localStorage
            if (currentEditResult.storageKey) {
                localStorage.setItem(currentEditResult.storageKey, JSON.stringify(currentEditResult));
            }
            
            // Update consolidated results
            const allStoredResults = JSON.parse(localStorage.getItem('allTestResults') || '[]');
            const index = allStoredResults.findIndex(r => r.id === currentEditResult.id);
            if (index !== -1) {
                allStoredResults[index] = currentEditResult;
                localStorage.setItem('allTestResults', JSON.stringify(allStoredResults));
            }
            
            // Refresh display
            loadAllResults();
            updateStatistics();
            closeModal();
            
            alert('Test result updated successfully!');
        });

        function deleteResult(id) {
            if (confirm('Are you sure you want to delete this test result? This action cannot be undone.')) {
                try {
                    let deleted = false;
                    
                    // Try persistent storage first
                    if (window.testStorage && typeof window.testStorage.deleteResult === 'function') {
                        const result = window.testStorage.deleteResult(id);
                        if (result.success) {
                            deleted = true;
                            console.log('✅ Result deleted using persistent storage');
                        }
                    }
                    
                    // Also handle legacy localStorage deletion (for backward compatibility)
                    const result = allResults.find(r => r.id === id || r.storageKey === id);
                    if (result) {
                        // Remove from individual storage
                        if (result.storageKey) {
                            localStorage.removeItem(result.storageKey);
                            deleted = true;
                        }
                        
                        // Remove from consolidated results
                        const allStoredResults = JSON.parse(localStorage.getItem('allTestResults') || '[]');
                        const filtered = allStoredResults.filter(r => r.id !== result.id);
                        localStorage.setItem('allTestResults', JSON.stringify(filtered));
                        deleted = true;
                    }
                    
                    if (deleted) {
                        loadAllResults();
                        updateStatistics();
                        alert('Test result deleted successfully!');
                        console.log('✅ Result deleted successfully:', id);
                    } else {
                        alert('Result not found or could not be deleted.');
                        console.log('⚠️ Result not found:', id);
                    }
                } catch (error) {
                    console.error('❌ Error deleting result:', error);
                    alert('Error deleting result. Please try again.');
                }
            }
        }



        function downloadResultPDF(id) {
            const result = allResults.find(r => r.id === id || r.storageKey === id);
            if (!result) return;
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Add content to PDF
            pdf.setFontSize(20);
            pdf.text('Speakers\' Corner - Test Results', 20, 30);
            
            pdf.setFontSize(16);
            pdf.text('B1 Reading Test - Cambridge English: Preliminary', 20, 45);
            
            pdf.setFontSize(12);
            pdf.text(`Student: ${result.studentName}`, 20, 65);
            pdf.text(`Email: ${result.studentEmail}`, 20, 75);
            pdf.text(`Test Date: ${result.testDate}`, 20, 85);
            pdf.text(`Test Time: ${result.testTime}`, 20, 95);
            
            pdf.setFontSize(16);
            pdf.text(`Score: ${result.score}/${result.totalQuestions} (${result.percentage}%)`, 20, 115);
            
            const grade = calculateGrade(result.percentage);
            pdf.text(`Grade: ${grade.grade}`, 20, 130);
            
            pdf.save(`${result.studentName}_B1_Reading_Results.pdf`);
        }

        function exportResults() {
            const testLevel = document.getElementById('testLevelFilter').value;
            
            if (window.testDB) {
                window.testDB.exportToCSV(testLevel || null);
            } else {
                // Fallback export
                exportResultsFallback(testLevel);
            }
        }

        function exportResultsFallback(testLevel) {
            const resultsToExport = testLevel ? 
                allResults.filter(r => (r.testLevel || 'B1') === testLevel) : 
                allResults;

            if (resultsToExport.length === 0) {
                alert('No results to export!');
                return;
            }

            let csv = 'Test Level,Student Name,Email,Test Date,Test Time,Score,Total Questions,Percentage,Grade\n';
            
            resultsToExport.forEach(result => {
                const grade = calculateGrade(result.percentage);
                csv += `"${result.testLevel || 'B1'}","${result.studentName}","${result.studentEmail}","${result.testDate}","${result.testTime}",${result.totalScore || result.score},${result.totalQuestions},${result.percentage},"${grade.grade}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `test_results_${testLevel || 'all'}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function clearAllResults() {
            if (confirm('Are you sure you want to delete ALL test results? This action cannot be undone!')) {
                if (confirm('This will permanently delete all student test data. Are you absolutely sure?')) {
                    try {
                        let cleared = false;
                        
                        // Try persistent storage first
                        if (window.testStorage && typeof window.testStorage.clearAllData === 'function') {
                            window.testStorage.clearAllData();
                            cleared = true;
                            console.log('✅ All data cleared using persistent storage');
                        } else {
                            console.log('⚠️ Persistent storage not available, using fallback');
                        }
                        
                        // Always also clear localStorage (for backward compatibility)
                        const keysToRemove = [];
                        for (let i = localStorage.length - 1; i >= 0; i--) {
                            const key = localStorage.key(i);
                            if (key && (key.startsWith('testResult_') || key === 'allTestResults' || key === 'testPortalDatabase' || key === 'testPortalBackup')) {
                                keysToRemove.push(key);
                            }
                        }
                        
                        keysToRemove.forEach(key => {
                            localStorage.removeItem(key);
                            cleared = true;
                        });
                        
                        console.log(`✅ Cleared ${keysToRemove.length} localStorage keys`);
                        
                        // Update UI
                        allResults = [];
                        filteredResults = [];
                        displayResults([]);
                        updateStatistics();
                        
                        if (cleared) {
                            alert('All test results have been deleted successfully.');
                            console.log('✅ All data cleared successfully');
                        } else {
                            alert('No test data found to delete.');
                            console.log('ℹ️ No data found to clear');
                        }
                        
                    } catch (error) {
                        console.error('❌ Error clearing data:', error);
                        alert('Error clearing data: ' + error.message + '\nPlease try again.');
                    }
                }
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initializing...');
            
            // Wait a moment for persistent storage to initialize
            setTimeout(() => {
                if (window.testStorage) {
                    console.log('✅ Persistent storage system available');
                } else {
                    console.log('⚠️ Persistent storage not available, using localStorage fallback');
                }
                
                // Load all results
                loadAllResults();
                updateStatistics();
                
                console.log('Dashboard initialized successfully');
            }, 100);
        });
    </script>
</body>
</html>